<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- From here: http://stackoverflow.com/a/4389976 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Voronoi GPU</title>
    <link rel="stylesheet" href="style.css">
    <script src="demo-compiled.js"></script>
  </head>
  <body>
    <div id="demo-page">
      <h1>Voronoi Diagrams on the GPU</h1>

      <hr>

      <p class="disclaimer">
        The demos on this page use WebGL features that aren't available on many mobile devices. For the best experience, read this on a Desktop computer.
      </p>

      <hr>

      <p>
        What is a Voronoi diagram? Try the demo below to find out. When you click in the left canvas, you plant a colored &lsquo;seed&rsquo;. In the right canvas, every pixel takes the color of the closest seed. You can drag to plant lots of seeds.
      </p>

      <div id="paint-demo-container" class="demo-container">
        <canvas class="input-canvas"></canvas>
        <canvas class="output-canvas"></canvas>
      </div>

      <p>
        Demo #2: on the left is a scene with a few moving dots. On the right is the corresponding Voronoi diagram. Move your mouse over either canvas to control the location of the yellow dot. I like to pretend that it's a yellow fish swimming in water.
      </p>

      <div id="fish-demo-container" class="demo-container">
        <canvas class="input-canvas"></canvas>
        <canvas class="output-canvas"></canvas>
      </div>

      <p>
        Here's one more demo that I think is fun. In the left canvas there are seeds in a radial pattern overlaid on top of a photo. Each seed takes the color of the underlying pixel in the image. Move the circular handle to move the seeds and move the square handle to rotate them.
      </p>

      <div id="photo-demo-container" class="demo-container">
        <div class="input-canvas-container">
          <img id="eye" src="images/eye.jpg"></img>
          <canvas class="input-canvas"></canvas>
        </div>
        <canvas class="output-canvas"></canvas>
      </div>

      <h2>
        How does it work?
      </h2>

      <p>
        There are a few popular algorithms for computing Voronoi diagrams. I'll talk about the one that I used to build the demos above (by the way you can find the code for them <a target="blank_" href="https://github.com/ryankaplan/gpu-voronoi">here</a>). The approach is from a paper called <a href="http://www.comp.nus.edu.sg/~tants/jfa.html" target="blank_">Jump Flooding in GPU with Applications to Voronoi Diagram and Distance Transform</a>. We'll call it JFA - short for Jump Flooding Algorithm.
     </p>

      <p>
        The input to JFA is an image that looks like the left canvasses in the first two demos above: a blank background with some colored seeds on it. You iterate over the image in <i>rounds</i>, each with a <i>step length</i>, k. In a given round you iterate through each pixel (i, j) and look at 8 pixels around it. The 8 pixels that you look at aren't the immediate neighbours. They depend on the step length of the round that you're in. If your round has step length k, then you look at nearby pixels in the pattern shown in the diagram below.
      </p>

      <div style="width: 100%; text-align: center;">
          <div style="margin: auto; max-width: 400px;">
            <img style="width: 100%; height: 100%;" src="images/step-k.svg" alt="">
            <div class="image-caption">For each pixel that you process, you look for seeds in each cardinal and intercardinal direction.</div>
          </div>
      </div>

      <p>
        If your round has step length 1, then you look at your immediate neighbours. But if your step length is 10, then you look 10 pixels North, North-West, West, South-West, etc.
      </p>

      <p>
        At each stage of JFA, each pixel remembers the closest seed that it's seen so far. So when you visit new pixels in the pattern described above, you check to see if the pixel you're visiting knows about a closer seed than the closest one you've found so far.
      </p>

      <p>
        In an image of width and height N, JFA performs log(N) rounds. The first round has step length N / 2, then next has N / 4, the next has N / 8, and so on until N / k is 1.
      </p>

      <h2>
        Distance fields
      </h2>

      <p>
        JFA gives us two things for every pixel: the color of the closest seed, and the location of the closest seed. In the demos above, I use the color to draw Voronoi diagrams. In the demo below, I color each pixel based on the distance to the closest seed. Bright pixels are close to a seed and dark pixels are far from a seed.
      </p>

      <div id="distance-demo-container" class="demo-container">
        <canvas class="input-canvas"></canvas>
        <canvas class="output-canvas"></canvas>
      </div>

      <p>
        We can use this to expand shapes outward. Below is a demo where every dot in the simulation has been expanded out into a disk.
      </p>

      <div id="threshold-demo-container" class="demo-container">
        <canvas class="input-canvas"></canvas>
        <canvas class="output-canvas"></canvas>
      </div>

      <p>
        You can also use this to implement shadows. I'll add a demo for that soon.
      </p>


    </div>
    <div id="webgl-error" style="display: none;">
      This webpage uses WebGL which isn't supported by your browser. <br />
      </br>
      Sorry :(
    </div>
  </body>
</html>